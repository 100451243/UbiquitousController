<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Noflix login page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="../styles/style.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>
<body class="text-center align-middle">
<div class="container">
    <div class="row" style="background-color: #9ca3af;">
        <div class="col-md-12 gy-2" id="centeredBox">
<!--            <h1 class="p-5">Noflix</h1>-->
            <img src="/logo.png" alt="Noflix logo" class="mb-3 p-5">
            <p>Welcome! Scan this qr to begin</p>
            <h3> Scan me! </h3>
            <div class="image-wrapper p-3">
                <img src="qrcode.png" alt="This is the QR code for login" class="border border-2">
            </div>
            <p id="user"> You have been assigned user: </p>
        </div>
    </div>
</div>



<script>
    window.getCookie = function(name) {
        let match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
        if (match) return match[2];
    }

    let user = document.getElementById("user");
    //save cookie "id" in user.innerHTML
    user.innerHTML += getCookie("id");

    window.getCookie = function(name) {
        let match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
        if (match) return match[2];
    }
    let films = [];

    function setRandomBackground(time) {
        let randomFilm = films[Math.floor(Math.random() * films.length)];
        console.log((randomFilm).foldername);

        if (document.getElementById("CurrentBackgroundImage")) {        //remove previous background image
            //animate fade out previous image before removing it
            // let opacity = 0.8;
            // let interval = setInterval(function() {
            //     if (opacity <= 0.1) {
            //         clearInterval(interval);
            //         document.getElementById("CurrentBackgroundImage").remove();
            //     }
            //     opacity -= 0.1;
            //     document.getElementById("CurrentBackgroundImage").style.opacity = opacity;
            // }, 50);
            //
            document.getElementById("CurrentBackgroundImage").remove();
        }

        let image = document.createElement("img");
        image.src = "filmsLink/" + randomFilm.foldername + "/backdrop.jpg";
        image.id = "CurrentBackgroundImage";
        image.style.width = "100%";
        image.style.height = "100%";
        image.style.objectFit = "cover";
        image.style.position = "absolute";
        image.style.top = "0";
        image.style.left = "0";
        image.style.zIndex = "-1";
        image.style.opacity = "0";
        image.style.filter = "blur(2px)";
        document.body.appendChild(image);   //set background image
        //animate fadein new image
        let opacity = 0;
        let interval = setInterval(function() {
            if (opacity >= 0.8) {
                clearInterval(interval);
            }
            opacity += 0.1;
            document.getElementById("CurrentBackgroundImage").style.opacity = opacity;
        }, 50);
        setTimeout(function() {             //execute this function every 5 seconds
            setRandomBackground(time);
        }, time);
    }



    let socket = new WebSocket(location.origin.replace(/^http/, 'ws'));
    socket.onopen = function() {
        console.log("[open] Connection established, Sending to server");
        socket.send(JSON.stringify({"action":"waitLogin", "id":getCookie("id")}))
        socket.send(JSON.stringify({"action":"requestFilmsBeforeLogin", "id":getCookie("id")}))
    };
    socket.onmessage = function(event) {
        console.log(`[message] Data received from server: ${event.data}`);
        try {
            const data = JSON.parse(event.data);
            if (data.action === "reload" && data.id === getCookie("id")) {
                document.location.reload();
                alert("reloading")
            }
            if(data.action === "disconnect"){
                document.cookie = "id=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                document.location.reload();
            }
            if (data.action === "filmsInfo"){
                films = data.films;
                console.log(films)
                setRandomBackground(8000);
            }
        } catch (e) {}
    };
    socket.onclose = function(event) {
        if (event.wasClean) {
            alert(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
        } else {
            // e.g. server process killed or network down
            // event.code is usually 1006 in this case
            alert('[close] Connection died');
        }
    };
    socket.onerror = function(error) {
        alert(`[error]` + error.message);
    };



</script>
<!--<script>-->
<!--    setTimeout(function () { location.reload(); }, 1000);-->
<!--</script>-->
</body>
</html>
