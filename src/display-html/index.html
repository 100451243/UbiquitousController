<!DOCTYPE html>
    <html lang="es">
    <head>
        <base href=".">
        <meta charset="utf-8">
        <title>La mejor web de pel√≠culas</title>

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
            integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
            integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
            crossorigin="anonymous"></script>

        <link rel="stylesheet" type="text/css" href="../styles/cards.css">
    </head>
  
    <body>
        <header></header>

        <main>
  
   
            <div id="card-columns"></div>

        </main>

        <footer></footer>

<!--        <script src="../scripts/cards.js"></script>-->

        <script>

            window.getCookie = function(name) {
                let match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
                if (match) return match[2];
            }



            let socket = new WebSocket(location.origin.replace(/^http/, 'ws'));
            socket.onopen = function(e) {
                console.log("[open] Connection established, Sending to server");
                alert("Requesting films")
                socket.send(JSON.stringify({"action":"requestFilms", "id":document.cookie}))
            };
            socket.onmessage = function(event) {
                console.log(`[message] Data received from server: ${event.data}`);
                try {
                    const data = JSON.parse(event.data);
                    if (data.action === "reload" && data.id === getCookie("id")) {
                        document.location.reload();
                        alert("reloading")
                    }
                    if (data.action === "films"){
                        alert("films received")
                        var films = data.films;

                        let display = document.getElementById("card-columns");
                        films.forEach(film => {
                            console.log(film)
                            let card = document.createElement("div");
                            card.className = "card";
                            let img = document.createElement("img");
                            img.className = "card-img-top";
                            img.src = "filmsLink/" + film.foldername + "/folder.jpg";
                            let card_body = document.createElement("div");
                            card_body.className = "card-body";
                            let card_title = document.createElement("h5");
                            card_title.className = "card-title";
                            card_title.innerHTML = film.title;
                            let card_text = document.createElement("p");
                            card_text.className = "card-text";
                            card_text.innerHTML = film.metadata.tagline;
                            let card_footer = document.createElement("div");
                            card_footer.className = "card-footer";
                            card_footer.innerHTML = film.metadata.rating;
                            let card_footer_text = document.createElement("small");
                            card_footer_text.className = "text-muted";
                            card_footer_text.innerHTML = "    " + film.metadata.year;
                            card_footer.appendChild(card_footer_text);
                            card_body.appendChild(card_title);
                            card_body.appendChild(card_text);
                            card.appendChild(img);
                            card.appendChild(card_body);
                            card.appendChild(card_footer);
                            display.appendChild(card);
                        });


                    }

                } catch (e) {}
            };
            socket.onclose = function(event) {
                if (event.wasClean) {
                    alert(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
                } else {
                    // e.g. server process killed or network down
                    // event.code is usually 1006 in this case
                    alert('[close] Connection died');
                }
            };
            socket.onerror = function(error) {
                alert(`[error]` + error.message);
            };



        </script>

    </body>
</html>