<!DOCTYPE html>
    <html lang="es">
    <head>
        <base href=".">
        <meta charset="utf-8">
        <title>Noflix, pel√≠culas a la carta</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
            integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
            crossorigin="anonymous"></script>

        <link rel="stylesheet" type="text/css" href="../styles/cards.css">
    </head>
  
    <body>
        <header></header>

        <main>
  
   
            <div id="card-columns"></div>

        </main>

        <footer></footer>

<!--        <script src="../scripts/cards.js"></script>-->

        <script>

            window.getCookie = function(name) {
                let match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
                if (match) return match[2];
            }


            let films = [];
            let selected = undefined;

            let socket = new WebSocket(location.origin.replace(/^http/, 'ws'));
            socket.onopen = function(e) {
                console.log("[open] Connection established, Sending to server");
                alert("Requesting films")
                socket.send(JSON.stringify({"action":"requestFilms", "id":getCookie("id")}))
            };
            socket.onmessage = function(event) {
                console.log(`[message] Data received from server: ${event.data}`);
                try {
                    const data = JSON.parse(event.data);
                    if (data.action === "reload" && data.id === getCookie("id")) {
                        document.location.reload();
                        alert("reloading")
                    }
                    if (data.action === "films"){
                        alert("films received")
                        films = data.films;

                        let display = document.getElementById("card-columns");
                        films.forEach(film => {
                            console.log(film)
                            let card = document.createElement("div");
                            card.className = "card";
                            card.onclick = function() {
                                document.location.href = "filmsLink/" + film.foldername + "/" + film.file;
                            }
                            let img = document.createElement("img");
                            img.className = "card-img-top";
                            img.src = "filmsLink/" + film.foldername + "/folder.jpg";
                            //set img so it doesnt stretch
                            img.style = "object-fit: cover; height: 28rem;";
                            let card_body = document.createElement("div");
                            card_body.className = "card-body";
                            let card_title = document.createElement("h5");
                            card_title.className = "card-title";
                            card_title.innerHTML = film.title;
                            let card_text = document.createElement("p");
                            card_text.className = "card-text";
                            card_text.innerHTML = film.metadata.tagline;
                            let card_footer = document.createElement("div");
                            card_footer.className = "card-footer";
                            card_footer.innerHTML = film.metadata.rating;
                            let card_footer_text = document.createElement("small");
                            card_footer_text.className = "text-muted";
                            card_footer_text.innerHTML = "    " + film.metadata.year;
                            card_footer.appendChild(card_footer_text);
                            card_body.appendChild(card_title);
                            card_body.appendChild(card_text);
                            card.appendChild(img);
                            card.appendChild(card_body);
                            card.appendChild(card_footer);
                            display.appendChild(card);
                        });
                    }
                    console.log(selected)
                    let display = document.getElementById("card-columns");
                    if(data.action === "right-swipe"){
                        if (selected === undefined) {
                            selected = 0;
                        } else if (selected < films.length - 1) {
                            display.childNodes[selected].style.backgroundColor = "white";
                            selected++;
                        }
                        display.childNodes[selected].style.backgroundColor = "green";
                        display.childNodes[selected].scrollIntoView({ behavior: "smooth", block: "end", inline: "nearest" });
                    }
                    if(data.action === "left-swipe"){
                        if (selected === undefined) {
                            selected = 0;
                        } else if (selected > 0) {
                            display.childNodes[selected].style.backgroundColor = "white";
                            selected--;
                        }
                        display.childNodes[selected].style.backgroundColor = "red";
                        display.childNodes[selected].scrollIntoView({ behavior: "smooth", block: "end", inline: "nearest" });
                    }
                    let movement = Math.ceil(window.innerWidth / 300)-1;
                    if(data.action === "up-swipe"){
                        if (selected === undefined) {
                            selected = 0;
                        } else  {
                            display.childNodes[selected].style.backgroundColor = "white";
                            selected= selected - movement < 0 ? 0 : selected - movement;
                        }
                        display.childNodes[selected].style.backgroundColor = "red";
                        display.childNodes[selected].scrollIntoView({ behavior: "smooth", block: "end", inline: "nearest" });
                    }
                    if(data.action === "down-swipe"){
                        if (selected === undefined) {
                            selected = 0;
                        } else  {
                            display.childNodes[selected].style.backgroundColor = "white";
                            selected = selected + movement > films.length - 1 ? films.length - 1 : selected + movement;
                        }
                        display.childNodes[selected].style.backgroundColor = "green";
                        display.childNodes[selected].scrollIntoView({ behavior: "smooth", block: "end", inline: "nearest" });
                    }
                    if(data.action === "tap"){
                        if (selected === undefined) {
                            console.log("Nothing selected");
                        }else if(0>5){
                            console.log("begin playing")
                            let title_image = document.createElement("img");
                            title_image.src = "filmsLink/" + films[selected].foldername + "/clearart.png";
                            //set image, so it hovers over the top right corner of the video
                            title_image.style = "position: absolute; top: 0; right: 0; width: 20%; height: 20%; object-fit: cover;";

                            let logo_image = document.createElement("img");
                            logo_image.src = "filmsLink/" + films[selected].foldername + "/logo.png";
                            //set image, so it hovers over the top left corner of the video
                            logo_image.style = "position: absolute; top: 0; left: 0; width: 20%; height: 20%; object-fit: cover;";

                            let video = document.createElement("video");
                            //video.playsInline = true;
                            video.src = "filmsLink/" + films[selected].foldername + "/" + films[selected].file;
                            video.controls = true;
                            //video.autoplay = true;
                            video.play();
                            let container = document.createElement("div");
                            container.appendChild(logo_image);
                            container.appendChild(title_image);
                            container.appendChild(video);
                            let plot = document.createElement("p");
                            plot.innerHTML = films[selected].metadata.plot;
                            container.appendChild(plot);
                            document.body.innerHTML = container.outerHTML;
                        }
                        else{
                            document.location.href = "film_info?film=" + selected + "&id=" + getCookie("id");
                        }

                    }
                    if(data.action === "disconnect"){
                        document.cookie = "id=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                        document.location.reload();
                    }
                } catch (e) {}
            };
            socket.onclose = function(event) {
                if (event.wasClean) {
                    alert(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
                } else {
                    // e.g. server process killed or network down
                    // event.code is usually 1006 in this case
                    alert('[close] Connection died');
                }
                document.cookie = "id=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                document.location.reload();
            };
            socket.onerror = function(error) {
                alert(`[error]` + error.message);
            };



        </script>

    </body>
</html>